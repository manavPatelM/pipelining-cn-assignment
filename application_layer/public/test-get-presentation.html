<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test GET Presentation Layer Endpoint</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/sidebar.css">
  <style>
    .instruction-box {
      background: #1e3a5f;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .step {
      background: #0b1322;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
    }
    .step-number {
      display: inline-block;
      width: 28px;
      height: 28px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-weight: 600;
      margin-right: 8px;
    }
    .envelope-list {
      background: #000;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin: 8px 0;
    }
    .envelope-item {
      padding: 6px;
      margin: 4px 0;
      background: #0b1322;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .envelope-item:hover {
      background: #1e3a5f;
      border-color: var(--accent);
    }
    .json-output {
      background: #000;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      margin: 16px 0;
      overflow-x: auto;
      max-height: 500px;
    }
    .json-output pre {
      margin: 0;
      color: #a5f3fc;
      font-size: 13px;
      line-height: 1.6;
    }
    .copy-btn {
      float: right;
      padding: 4px 12px;
      font-size: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .copy-btn:hover {
      background: #2563eb;
    }
  </style>
</head>
<body class="bg">
  <script src="/sidebar.js"></script>
  <script>document.write(createSidebar('presentation-get'))</script>
  
  <div class="content-with-sidebar">
  <header class="topbar">
    <div class="brand">Test GET Presentation Layer Endpoint</div>
  </header>

  <main class="shell">
    <section class="card">
      <h1>How to Test GET Endpoint</h1>
      <p class="muted">Send existing envelope data to Presentation layer</p>

      <div class="instruction-box">
        <h3 style="margin-top: 0;">ðŸ“‹ Instructions</h3>
        <p>The GET endpoint retrieves an existing envelope from the outbox and prepares it for the Presentation layer.</p>
        <p><strong>Endpoint:</strong> <code style="background: #000; padding: 2px 6px; border-radius: 4px;">GET /api/v1/application/send-to-presentation/:envelopeId</code></p>
      </div>

      <!-- Step 1: Get Envelope ID -->
      <div class="step">
        <h3><span class="step-number">1</span>Get an Envelope ID</h3>
        <p class="muted">First, submit a message using the Message Composer. The envelope IDs are filenames without the .json extension.</p>
        <button onclick="loadEnvelopes()" style="margin: 8px 0;">ðŸ“‚ Load Available Envelopes</button>
        <div id="envelopeList"></div>
      </div>

      <!-- Step 2: Test the Endpoint -->
      <div class="step">
        <h3><span class="step-number">2</span>Test the GET Endpoint</h3>
        <p class="muted">Enter an envelope ID below or click one from the list above.</p>
        <div style="display: flex; gap: 8px; margin: 12px 0;">
          <input 
            type="text" 
            id="envelopeId" 
            placeholder="e.g., 2025-10-27T08-32-09-517Z-725y0y" 
            style="flex: 1;"
          />
          <button onclick="testGetEndpoint()" style="padding: 8px 16px;">ðŸš€ Send to Presentation Layer</button>
        </div>
      </div>

      <!-- Step 3: View Response -->
      <div class="step">
        <h3><span class="step-number">3</span>View Presentation Layer Data</h3>
        <div id="responseSection" style="display: none;">
          <button class="copy-btn" onclick="copyResponse()">ðŸ“‹ Copy JSON</button>
          <div class="json-output">
            <pre id="responseOutput"></pre>
          </div>
        </div>
        <div id="noResponse" style="color: var(--muted); padding: 20px; text-align: center;">
          No response yet. Enter an envelope ID above and click "Send to Presentation Layer".
        </div>
      </div>

      <!-- Alternative: Use cURL -->
      <div class="step">
        <h3><span class="step-number">4</span>Alternative: Use cURL or Browser</h3>
        <p class="muted">You can also test directly using:</p>
        
        <div style="margin: 12px 0;">
          <strong>Browser URL:</strong>
          <div style="background: #000; padding: 12px; border-radius: 6px; margin: 8px 0; overflow-x: auto;">
            <code id="browserUrl" style="color: #a5f3fc;">http://127.0.0.1:3000/api/v1/application/send-to-presentation/YOUR_ENVELOPE_ID</code>
          </div>
        </div>

        <div style="margin: 12px 0;">
          <strong>PowerShell Command:</strong>
          <div style="background: #000; padding: 12px; border-radius: 6px; margin: 8px 0; overflow-x: auto;">
            <code id="curlCmd" style="color: #a5f3fc;">Invoke-RestMethod -Uri "http://127.0.0.1:3000/api/v1/application/send-to-presentation/YOUR_ENVELOPE_ID" | ConvertTo-Json -Depth 10</code>
          </div>
        </div>
      </div>

  </main>

  <footer class="footer">
    GET endpoint retrieves envelopes from outbox/ directory
  </footer>
  </div>

  <script>
    async function loadEnvelopes() {
      const listDiv = document.getElementById('envelopeList')
      listDiv.innerHTML = '<div style="padding: 12px; color: var(--muted);">Loading envelopes...</div>'

      try {
        // Fetch envelope files from outbox
        const response = await fetch('/api/v1/application/outbox/list')
        
        if (!response.ok) {
          throw new Error('Failed to fetch envelopes')
        }

        const data = await response.json()
        
        if (!data.envelopes || data.envelopes.length === 0) {
          listDiv.innerHTML = '<div style="padding: 12px; color: var(--muted);">No envelopes found. Create one using the <a href="/" style="color: var(--accent);">Message Composer</a>.</div>'
          return
        }

        listDiv.innerHTML = '<div class="envelope-list">' + 
          data.envelopes.map(env => 
            `<div class="envelope-item" onclick="selectEnvelope('${env.id}')">
              ðŸ“§ ${env.id}
              <div style="font-size: 10px; color: var(--muted); margin-top: 4px;">
                ${env.sender} â†’ ${env.receiver} | ${new Date(env.created).toLocaleString()}
              </div>
            </div>`
          ).join('') + 
          '</div>'
      } catch (error) {
        listDiv.innerHTML = `<div style="padding: 12px; color: #ef4444;">Error: ${error.message}</div>`
      }
    }

    function selectEnvelope(envelopeId) {
      document.getElementById('envelopeId').value = envelopeId
      updateCommands(envelopeId)
    }

    function updateCommands(envelopeId) {
      document.getElementById('browserUrl').textContent = 
        `http://127.0.0.1:3000/api/v1/application/send-to-presentation/${envelopeId}`
      document.getElementById('curlCmd').textContent = 
        `Invoke-RestMethod -Uri "http://127.0.0.1:3000/api/v1/application/send-to-presentation/${envelopeId}" | ConvertTo-Json -Depth 10`
    }

    async function testGetEndpoint() {
      const envelopeId = document.getElementById('envelopeId').value.trim()
      
      if (!envelopeId) {
        alert('Please enter an envelope ID')
        return
      }

      updateCommands(envelopeId)

      const responseSection = document.getElementById('responseSection')
      const noResponse = document.getElementById('noResponse')
      const responseOutput = document.getElementById('responseOutput')

      noResponse.textContent = 'Loading...'
      noResponse.style.display = 'block'
      responseSection.style.display = 'none'

      try {
        const response = await fetch(`/api/v1/application/send-to-presentation/${envelopeId}`)
        const data = await response.json()

        responseOutput.textContent = JSON.stringify(data, null, 2)
        responseSection.style.display = 'block'
        noResponse.style.display = 'none'
      } catch (error) {
        noResponse.textContent = `Error: ${error.message}`
        noResponse.style.color = '#ef4444'
      }
    }

    function copyResponse() {
      const text = document.getElementById('responseOutput').textContent
      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target
        const originalText = btn.textContent
        btn.textContent = 'âœ… Copied!'
        setTimeout(() => btn.textContent = originalText, 2000)
      })
    }
  </script>
</body>
</html>
